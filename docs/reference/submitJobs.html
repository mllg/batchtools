<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html>
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Submit Jobs to the Batch Systems — submitJobs • batchtools</title>

<!-- jquery -->
<script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">


<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script>
<script src="../pkgdown.js"></script>
  
  
<!-- mathjax -->
<script src='https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-reference-topic">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">batchtools</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/batchtools.html">Get Started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/mllg/batchtools">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>

      <div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Submit Jobs to the Batch Systems</h1>
    </div>

    
    <p>Submits defined jobs to the batch system.</p>
<p>After submitting the jobs, you can use <code><a href='waitForJobs.html'>waitForJobs</a></code> to wait for the
termination of jobs or call <code><a href='reduceResultsList.html'>reduceResultsList</a></code>/<code><a href='reduceResults.html'>reduceResults</a></code>
to collect partial results.
The progress can be monitored with <code><a href='getStatus.html'>getStatus</a></code>.</p>
    

    <pre class="usage"><span class='fu'>submitJobs</span>(<span class='kw'>ids</span> <span class='kw'>=</span> <span class='kw'>NULL</span>, <span class='kw'>resources</span> <span class='kw'>=</span> <span class='fu'>list</span>(), <span class='kw'>sleep</span> <span class='kw'>=</span> <span class='kw'>NULL</span>,
  <span class='kw'>reg</span> <span class='kw'>=</span> <span class='fu'><a href='getDefaultRegistry.html'>getDefaultRegistry</a></span>())</pre>
    
    <h2 class="hasAnchor" id="arguments"><a class="anchor" href="#arguments"></a> Arguments</h2>
    <table class="ref-arguments">
    <colgroup><col class="name" /><col class="desc" /></colgroup>
    <tr>
      <th>ids</th>
      <td><p>[<code><a href='http://www.rdocumentation.org/packages/base/topics/data.frame'>data.frame</a></code> or <code>integer</code>]
A <code><a href='http://www.rdocumentation.org/packages/base/topics/data.frame'>data.frame</a></code> (or <code><a href='http://www.rdocumentation.org/packages/data.table/topics/data.table'>data.table</a></code>)
with a column named &#8220;job.id&#8221;.
Alternatively, you may also pass a vector of integerish job ids.
If not set, defaults to the return value of <code><a href='findJobs.html'>findNotSubmitted</a></code>.
Invalid ids are ignored.</p></td>
    </tr>
    <tr>
      <th>resources</th>
      <td><p>[<code>named list</code>]
Computational  resources for the jobs to submit. The actual elements of this list
(e.g. something like &#8220;walltime&#8221; or &#8220;nodes&#8221;) depend on your template file, exceptions are outlined in the details.
In case you need to set individual job resources, <code>ids</code> may be provided as <code>data.frame</code> with the additional
column &#8220;resources&#8221; (see example).
Default settings for a system can be set in the configuration file by defining the named list <code>default.resources</code>.
Note that these settings are merged by name, e.g. merging <code>list(walltime = 300)</code> into <code>list(walltime = 400, memory = 512)</code>
will result in <code>list(walltime = 300, memory = 512)</code>.</p></td>
    </tr>
    <tr>
      <th>sleep</th>
      <td><p>[<code>function(i)</code> | <code>numeric(1)</code>]
Parameter to control the duration to sleep between temporary errors.
You can pass an absolute numeric value in seconds or a <code>function(i)</code> which returns the number of seconds to sleep in the <code>i</code>-th
iteration between temporary errors.
If not provided (<code>NULL</code>), tries to read the value (number/function) from the configuration file (stored in <code>reg$sleep</code>) or defaults to
a function with exponential backoff between 5 and 120 seconds.</p></td>
    </tr>
    <tr>
      <th>reg</th>
      <td><p>[<code><a href='makeRegistry.html'>Registry</a></code>]
Registry. If not explicitly passed, uses the default registry (see <code><a href='getDefaultRegistry.html'>setDefaultRegistry</a></code>).</p></td>
    </tr>
    </table>
    
    <h2 class="hasAnchor" id="value"><a class="anchor" href="#value"></a>Value</h2>

    <p>[<code>data.table</code>] with columns &#8220;job.id&#8221; and &#8220;chunk&#8221;.</p>
    
    <h2 class="hasAnchor" id="note"><a class="anchor" href="#note"></a>Note</h2>

    <p>If you a large number of jobs, disabling the progress bar (<code>options(batchtools.progress = FALSE)</code>)
can significantly increase the performance of <code>submitJobs</code>.</p>
    
    <h2 class="hasAnchor" id="chunking-of-jobs"><a class="anchor" href="#chunking-of-jobs"></a>Chunking of Jobs</h2>

    
    <p>Multiple jobs can be grouped (chunked) together to be executed sequentially on the batch system as a single batch job.
This is especially useful to avoid overburding the scheduler by submitting thousands of jobs simultaneously.
To chunk jobs together, job ids must be provided as <code>data.frame</code> with columns &#8220;job.id&#8221; and &#8220;chunk&#8221; (integer).
All jobs with the same chunk number will be executed sequentially inside the same batch job.
The utility functions <code><a href='chunk.html'>chunk</a></code>, <code><a href='chunk.html'>binpack</a></code> and <code><a href='chunk.html'>lpt</a></code>
can assist in grouping jobs.</p>
    
    <h2 class="hasAnchor" id="array-jobs"><a class="anchor" href="#array-jobs"></a>Array Jobs</h2>

    
    <p>If your cluster supports array jobs, you can set the resource <code>chunks.as.arrayjobs</code> to <code>TRUE</code> in order
to execute chunks as job arrays. To do so, the job must be repeated <code>nrow(jobs)</code> times via the cluster functions template.
The function <code><a href='doJobCollection.html'>doJobCollection</a></code> (which is called on the slave) now retrieves the repetition number from the environment
and restricts the computation to the respective job in the <code><a href='JobCollection.html'>JobCollection</a></code>.</p>
    
    <h2 class="hasAnchor" id="order-of-submission"><a class="anchor" href="#order-of-submission"></a>Order of Submission</h2>

    
    <p>Jobs are submitted in the order of chunks, i.e. jobs which have chunk number
<code>sort(unique(ids$chunk))[1]</code> first, then jobs with chunk number <code>sort(unique(ids$chunk))[2]</code>
and so on. If no chunks are provided, jobs are submitted in the order of <code>ids$job.id</code>.</p>
    
    <h2 class="hasAnchor" id="limiting-the-number-of-jobs"><a class="anchor" href="#limiting-the-number-of-jobs"></a>Limiting the Number of Jobs</h2>

    
    <p>If requested, <code>submitJobs</code> tries to limit the number of concurrent jobs of the user by waiting until jobs terminate
before submitting new ones.
This can be controlled by setting &#8220;max.concurrent.jobs&#8221; in the configuration file (see <code><a href='makeRegistry.html'>Registry</a></code>)
or by setting the resource &#8220;max.concurrent.jobs&#8221; to the maximum number of jobs to run simultaneously.
If both are set, the setting via the resource takes precedence over the setting in the configuration.</p>
    
    <h2 class="hasAnchor" id="measuring-memory"><a class="anchor" href="#measuring-memory"></a>Measuring Memory</h2>

    
    <p>Setting the resource <code>measure.memory</code> to <code>TRUE</code> turns on memory measurement:
<code><a href='http://www.rdocumentation.org/packages/base/topics/gc'>gc</a></code> is called  directly before and after the job and the difference is
stored in the internal database. Note that this is just a rough estimate and does
neither work reliably for external code like C/C++ nor in combination with threading.</p>
    
    <h2 class="hasAnchor" id="inner-parallelization"><a class="anchor" href="#inner-parallelization"></a>Inner Parallelization</h2>

    
    <p>Inner parallelization is typically done via threading, sockets or MPI.
Two backends are supported to assist in setting up inner parallelization.</p>
<p>The first package is <span class="pkg">parallelMap</span>.
If you set the resource &#8220;pm.backend&#8221; to &#8220;multicore&#8221;, &#8220;socket&#8221; or &#8220;mpi&#8221;,
<code><a href='http://www.rdocumentation.org/packages/parallelMap/topics/parallelStart'>parallelStart</a></code> is called on the slave before the first job in the chunk is started
and <code><a href='http://www.rdocumentation.org/packages/parallelMap/topics/parallelStop'>parallelStop</a></code> is called after the last job terminated.
This way, the resources for inner parallelization can be set and get automatically stored just like other computational resources.
The function provided by the user just has to call <code><a href='http://www.rdocumentation.org/packages/parallelMap/topics/parallelMap'>parallelMap</a></code> to start parallelization using the preconfigured backend.</p>
<p>To control the number of CPUs, you have to set the resource <code>ncpus</code>.
Otherwise <code>ncpus</code> defaults to the number of available CPUs (as reported by (see <code><a href='http://www.rdocumentation.org/packages/parallel/topics/detectCores'>detectCores</a></code>))
on the executing machine for multicore and socket mode and defaults to the return value of <code><a href='http://www.rdocumentation.org/packages/Rmpi/topics/mpi.universe.size'>mpi.universe.size</a>-1</code> for MPI.
Your template must be set up to handle the parallelization, e.g. request the right number of CPUs or start R with <code>mpirun</code>.
You may pass further options like <code>level</code> to <code><a href='http://www.rdocumentation.org/packages/parallelMap/topics/parallelStart'>parallelStart</a></code> via the named list &#8220;pm.opts&#8221;.</p>
<p>The second supported parallelization backend is <span class="pkg">foreach</span>.
If you set the resource &#8220;foreach.backend&#8221; to &#8220;seq&#8221; (sequential mode), &#8220;parallel&#8221; (<span class="pkg">doParallel</span>) or
&#8220;mpi&#8221; (<span class="pkg">doMPI</span>), the requested <span class="pkg">foreach</span> backend is automatically registered on the slave.
Again, the resource <code>ncpus</code> is used to determine the number of CPUs.</p>
<p>Neither the namespace of <span class="pkg">parallelMap</span> nor the namespace <span class="pkg">foreach</span> are attached.
You have to do this manually via <code><a href='http://www.rdocumentation.org/packages/base/topics/library'>library</a></code> or let the registry load the packages for you.</p>
    

    <h2 class="hasAnchor" id="examples"><a class="anchor" href="#examples"></a>Examples</h2>
    <pre class="examples"><div class='input'><span class='co'>### Example 1: Using memory measurement</span>
<span class='no'>tmp</span> <span class='kw'>=</span> <span class='fu'><a href='makeRegistry.html'>makeRegistry</a></span>(<span class='kw'>file.dir</span> <span class='kw'>=</span> <span class='fl'>NA</span>, <span class='kw'>make.default</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>)</div><div class='output co'>#&gt; <span class='message'>Sourcing configuration file '/home/lang/.config/batchtools/config.R' ...</span></div><div class='output co'>#&gt; <span class='message'>Created registry in '/tmp/batchtools-example/reg1' using cluster functions 'Interactive'</span></div><div class='input'>
<span class='co'># Toy function which creates a large matrix and returns the column sums</span>
<span class='no'>fun</span> <span class='kw'>=</span> <span class='kw'>function</span>(<span class='no'>n</span>, <span class='no'>p</span>) <span class='fu'>colMeans</span>(<span class='fu'>matrix</span>(<span class='fu'>runif</span>(<span class='no'>n</span>*<span class='no'>p</span>), <span class='no'>n</span>, <span class='no'>p</span>))

<span class='co'># Arguments to fun:</span>
<span class='no'>args</span> <span class='kw'>=</span> <span class='fu'>CJ</span>(<span class='kw'>n</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>1e4</span>, <span class='fl'>1e5</span>), <span class='kw'>p</span> <span class='kw'>=</span> <span class='fu'>c</span>(<span class='fl'>10</span>, <span class='fl'>50</span>)) <span class='co'># like expand.grid()</span>
<span class='fu'>print</span>(<span class='no'>args</span>)</div><div class='output co'>#&gt;        n     p
#&gt;    &lt;num&gt; &lt;num&gt;
#&gt; 1: 1e+04    10
#&gt; 2: 1e+04    50
#&gt; 3: 1e+05    10
#&gt; 4: 1e+05    50</div><div class='input'>
<span class='co'># Map function to create jobs</span>
<span class='no'>ids</span> <span class='kw'>=</span> <span class='fu'><a href='batchMap.html'>batchMap</a></span>(<span class='no'>fun</span>, <span class='kw'>args</span> <span class='kw'>=</span> <span class='no'>args</span>, <span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)</div><div class='output co'>#&gt; <span class='message'>Adding 4 jobs ...</span></div><div class='input'>
<span class='co'># Set resources: enable memory measurement</span>
<span class='no'>res</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>measure.memory</span> <span class='kw'>=</span> <span class='fl'>TRUE</span>)

<span class='co'># Submit jobs using the currently configured cluster functions</span>
<span class='fu'>submitJobs</span>(<span class='no'>ids</span>, <span class='kw'>resources</span> <span class='kw'>=</span> <span class='no'>res</span>, <span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)</div><div class='output co'>#&gt; <span class='message'>Submitting 4 jobs in 4 chunks using cluster functions 'Interactive' ...</span></div><div class='output co'>#&gt; <span class='message'>### [bt]: Setting seed to 1 ...</span></div><div class='output co'>#&gt; <span class='message'>### [bt]: Setting seed to 2 ...</span></div><div class='output co'>#&gt; <span class='message'>### [bt]: Setting seed to 3 ...</span></div><div class='output co'>#&gt; <span class='message'>### [bt]: Setting seed to 4 ...</span></div><div class='input'>
<span class='co'># Retrive information about memory, combine with parameters</span>
<span class='no'>info</span> <span class='kw'>=</span> <span class='fu'><a href='JoinTables.html'>ijoin</a></span>(<span class='fu'><a href='getJobTable.html'>getJobStatus</a></span>(<span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)[, <span class='fu'>.</span>(<span class='no'>job.id</span>, <span class='no'>mem.used</span>)], <span class='fu'><a href='getJobTable.html'>getJobPars</a></span>(<span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>))
<span class='fu'>print</span>(<span class='fu'><a href='unwrap.html'>unwrap</a></span>(<span class='no'>info</span>))</div><div class='output co'>#&gt;    job.id mem.used     n     p
#&gt;     &lt;int&gt;    &lt;num&gt; &lt;num&gt; &lt;num&gt;
#&gt; 1:      1    142.2 1e+04    10
#&gt; 2:      2    146.8 1e+04    50
#&gt; 3:      3    154.5 1e+05    10
#&gt; 4:      4    215.1 1e+05    50</div><div class='input'>
<span class='co'># Combine job info with results -&gt; each job is aggregated using mean()</span>
<span class='fu'><a href='unwrap.html'>unwrap</a></span>(<span class='fu'><a href='JoinTables.html'>ijoin</a></span>(<span class='no'>info</span>, <span class='fu'><a href='reduceResultsList.html'>reduceResultsDataTable</a></span>(<span class='kw'>fun</span> <span class='kw'>=</span> <span class='kw'>function</span>(<span class='no'>res</span>) <span class='fu'>list</span>(<span class='kw'>res</span> <span class='kw'>=</span> <span class='fu'>mean</span>(<span class='no'>res</span>)), <span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)))</div><div class='output co'>#&gt;    job.id mem.used     n     p       res
#&gt;     &lt;int&gt;    &lt;num&gt; &lt;num&gt; &lt;num&gt;     &lt;num&gt;
#&gt; 1:      1    142.2 1e+04    10 0.5010869
#&gt; 2:      2    146.8 1e+04    50 0.4993332
#&gt; 3:      3    154.5 1e+05    10 0.4996469
#&gt; 4:      4    215.1 1e+05    50 0.5000530</div><div class='input'>
<span class='co'>### Example 2: Multicore execution on the slave</span>
<span class='no'>tmp</span> <span class='kw'>=</span> <span class='fu'><a href='makeRegistry.html'>makeRegistry</a></span>(<span class='kw'>file.dir</span> <span class='kw'>=</span> <span class='fl'>NA</span>, <span class='kw'>make.default</span> <span class='kw'>=</span> <span class='fl'>FALSE</span>)</div><div class='output co'>#&gt; <span class='message'>Sourcing configuration file '/home/lang/.config/batchtools/config.R' ...</span></div><div class='output co'>#&gt; <span class='message'>Created registry in '/tmp/batchtools-example/reg2' using cluster functions 'Interactive'</span></div><div class='input'>
<span class='co'># Function which sleeps 10 seconds, i-times</span>
<span class='no'>f</span> <span class='kw'>=</span> <span class='kw'>function</span>(<span class='no'>i</span>) {
  <span class='kw pkg'>parallelMap</span><span class='kw ns'>::</span><span class='fu'><a href='http://www.rdocumentation.org/packages/parallelMap/topics/parallelMap'>parallelMap</a></span>(<span class='no'>Sys.sleep</span>, <span class='fu'>rep</span>(<span class='fl'>10</span>, <span class='no'>i</span>))
}

<span class='co'># Create one job with parameter i=4</span>
<span class='no'>ids</span> <span class='kw'>=</span> <span class='fu'><a href='batchMap.html'>batchMap</a></span>(<span class='no'>f</span>, <span class='kw'>i</span> <span class='kw'>=</span> <span class='fl'>4</span>, <span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)</div><div class='output co'>#&gt; <span class='message'>Adding 1 jobs ...</span></div><div class='input'>
<span class='co'># Set resources: Use parallelMap in multicore mode with 4 CPUs</span>
<span class='co'># batchtools internally loads the namespace of parallelMap and then</span>
<span class='co'># calls parallelStart() before the job and parallelStop() right</span>
<span class='co'># after the job last job in the chunk terminated.</span>
<span class='no'>res</span> <span class='kw'>=</span> <span class='fu'>list</span>(<span class='kw'>pm.backend</span> <span class='kw'>=</span> <span class='st'>"multicore"</span>, <span class='kw'>ncpus</span> <span class='kw'>=</span> <span class='fl'>4</span>)</div><span class='co'># NOT RUN {</span>
<span class='co'># Submit both jobs and wait for them</span>
<span class='fu'>submitJobs</span>(<span class='kw'>resources</span> <span class='kw'>=</span> <span class='no'>res</span>, <span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)
<span class='fu'><a href='waitForJobs.html'>waitForJobs</a></span>(<span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)

<span class='co'># If successfull, the running time should be ~10s</span>
<span class='fu'><a href='getJobTable.html'>getJobTable</a></span>(<span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)[, <span class='fu'>.</span>(<span class='no'>job.id</span>, <span class='no'>time.running</span>)]

<span class='co'># There should also be a note in the log:</span>
<span class='fu'><a href='grepLogs.html'>grepLogs</a></span>(<span class='kw'>pattern</span> <span class='kw'>=</span> <span class='st'>"parallelMap"</span>, <span class='kw'>reg</span> <span class='kw'>=</span> <span class='no'>tmp</span>)
<span class='co'># }</span></pre>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
    <h2>Contents</h2>
    <ul class="nav nav-pills nav-stacked">
      <li><a href="#arguments">Arguments</a></li>
      
      <li><a href="#value">Value</a></li>

      <li><a href="#note">Note</a></li>

      <li><a href="#chunking-of-jobs">Chunking of Jobs</a></li>

      <li><a href="#array-jobs">Array Jobs</a></li>

      <li><a href="#order-of-submission">Order of Submission</a></li>

      <li><a href="#limiting-the-number-of-jobs">Limiting the Number of Jobs</a></li>

      <li><a href="#measuring-memory">Measuring Memory</a></li>

      <li><a href="#inner-parallelization">Inner Parallelization</a></li>
      
      <li><a href="#examples">Examples</a></li>
    </ul>

  </div>
</div>

      <footer>
      <div class="copyright">
  <p>Developed by Michel Lang, Bernd Bischl.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
   </div>

  </body>
</html>
