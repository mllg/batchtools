<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example 2: Problems and Algorithms â€¢ batchtools</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">batchtools</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mllg/batchtools">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Example 2: Problems and Algorithms</h1>
            
          </div>

    
    
<div class="contents">
<div id="intro" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#intro" class="anchor"> </a></body></html>Intro</h1>
<p>We stick to a rather simple, but not unrealistic example to explain some further functionalities: Applying two classification learners to the famous iris data set (Anderson 1935), vary a few hyperparameters and evaluate the effect on the classification performance.</p>
<p>First, we create a registry, the central meta-data object which records technical details and the setup of the experiments. We use an <a href="https://mllg.github.io/batchtools/reference/makeExperimentRegistry"><code>ExperimentRegistry</code></a> where the job definition is split into creating problems and algorithms. See the paper on <a href="http://www.jstatsoft.org/article/view/v064i11">BatchJobs and BatchExperiments</a> for a detailed explanation. Again, we use a temporary registry and make it the default registry.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(batchtools)
reg =<span class="st"> </span><span class="kw"><a href="../reference/makeExperimentRegistry.html">makeExperimentRegistry</a></span>(<span class="dt">file.dir =</span> <span class="ot">NA</span>, <span class="dt">seed =</span> <span class="dv">1</span>)</code></pre></div>
</div>
<div id="problems-and-algorithms" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#problems-and-algorithms" class="anchor"> </a></body></html>Problems and algorithms</h1>
<p>By adding a problem to the registry, we can define the data on which certain computational jobs shall work. This can be a matrix, data frame or array that always stays the same for all subsequent experiments. But it can also be of a more dynamic nature, e.g., subsamples of a dataset or random numbers drawn from a probability distribution . Therefore the function <a href="https://mllg.github.io/batchtools/reference/addProblem"><code><a href="../reference/addProblem.html">addProblem()</a></code></a> accepts static parts in its <code>data</code> argument, which is passed to the argument <code>fun</code> which generates a (possibly stochastic) problem instance. For <code>data</code>, any R object can be used. If only <code>data</code> is given, the generated instance is <code>data</code>. The argument <code>fun</code> has to be a function with the arguments <code>data</code> and <code>job</code> (and optionally other arbitrary parameters). The argument <code>job</code> is an object of type <a href="https://mllg.github.io/batchtools/reference/JobExperiment"><code>Job</code></a> which holds additional information about the job.</p>
<p>We want to split the iris data set into a training set and test set. In this example we use use subsampling which just randomly takes a fraction of the observations as training set. We define a problem function which returns the indices of the respective training and test set for a split with <code>100 * ratio</code>% of the observations being in the test set:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">subsample =<span class="st"> </span>function(data, job, ratio, ...) {
  n =<span class="st"> </span><span class="kw">nrow</span>(data)
  train =<span class="st"> </span><span class="kw">sample</span>(n, <span class="kw">floor</span>(n *<span class="st"> </span>ratio))
  test =<span class="st"> </span><span class="kw">setdiff</span>(<span class="kw">seq_len</span>(n), train)
  <span class="kw">list</span>(<span class="dt">test =</span> test, <span class="dt">train =</span> train)
}</code></pre></div>
<p><a href="https://mllg.github.io/batchtools/reference/addProblem"><code><a href="../reference/addProblem.html">addProblem()</a></code></a> files the problem to the file system and the problem gets recorded in the registry.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">data</span>(<span class="st">"iris"</span>, <span class="dt">package =</span> <span class="st">"datasets"</span>)
<span class="kw"><a href="../reference/addProblem.html">addProblem</a></span>(<span class="dt">name =</span> <span class="st">"iris"</span>, <span class="dt">data =</span> iris, <span class="dt">fun =</span> subsample, <span class="dt">seed =</span> <span class="dv">42</span>)</code></pre></div>
<p>The function call will be evaluated at a later stage on the workers. In this process, the <code>data</code> part will be loaded and passed to the function. Note that we set a problem seed to synchronize the experiments in the sense that the same resampled training and test sets are used for the algorithm comparison in each distinct replication.</p>
<p>The algorithms for the jobs are added to the registry in a similar manner. When using <a href="https://mllg.github.io/batchtools/reference/addAlgorithm"><code><a href="../reference/addAlgorithm.html">addAlgorithm()</a></code></a>, an identifier as well as the algorithm to apply to are required arguments. The algorithm must be given as a function with arguments <code>job</code>, <code>data</code> and <code>instance</code>. Further arbitrary arguments (e.g., hyperparameters or strategy parameters) may be defined analogously as for the function in <code>addProblem</code>. The objects passed to the function via <code>job</code> and <code>data</code> are here the same as above, while via <code>instance</code> the return value of the evaluated problem function is passed. The algorithm can return any R object which will automatically be stored on the file system for later retrieval. Firstly, we create an algorithm which applies a support vector machine:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">svm.wrapper =<span class="st"> </span>function(data, job, instance, ...) {
  <span class="kw">library</span>(<span class="st">"e1071"</span>)
  mod =<span class="st"> </span><span class="kw">svm</span>(Species ~<span class="st"> </span>., <span class="dt">data =</span> data[instance$train, ], ...)
  pred =<span class="st"> </span><span class="kw">predict</span>(mod, <span class="dt">newdata =</span> data[instance$test, ], <span class="dt">type =</span> <span class="st">"class"</span>)
  <span class="kw">table</span>(data$Species[instance$test], pred)
}
<span class="kw"><a href="../reference/addAlgorithm.html">addAlgorithm</a></span>(<span class="dt">name =</span> <span class="st">"svm"</span>, <span class="dt">fun =</span> svm.wrapper)</code></pre></div>
<p>Secondly, a random forest of classification trees:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">forest.wrapper =<span class="st"> </span>function(data, job, instance, ...) {
  <span class="kw">library</span>(<span class="st">"ranger"</span>)
  mod =<span class="st"> </span><span class="kw">ranger</span>(Species ~<span class="st"> </span>., <span class="dt">data =</span> data[instance$train, ], <span class="dt">write.forest =</span> <span class="ot">TRUE</span>)
  pred =<span class="st"> </span><span class="kw">predict</span>(mod, <span class="dt">data =</span> data[instance$test, ])
  <span class="kw">table</span>(data$Species[instance$test], pred$predictions)
}
<span class="kw"><a href="../reference/addAlgorithm.html">addAlgorithm</a></span>(<span class="dt">name =</span> <span class="st">"forest"</span>, <span class="dt">fun =</span> forest.wrapper)</code></pre></div>
<p>Both algorithms return a confusion matrix for the predictions on the test set, which will later be used to calculate the misclassification rate.</p>
<p>Note that using the <code>...</code> argument in the wrapper definitions allows us to circumvent naming specific design parameters for now. This is an advantage if we later want to extend the set of algorithm parameters in the experiment. The algorithms get recorded in the registry and the corresponding functions are stored on the file system.</p>
<p>Defined problems and algorithms can be queried:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/addProblem.html">getProblemIds</a></span>()</code></pre></div>
<pre><code>## [1] "iris"</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/addAlgorithm.html">getAlgorithmIds</a></span>()</code></pre></div>
<pre><code>## [1] "svm"    "forest"</code></pre>
<p>The flow to define experiments is summarized in the following figure: <img src="tikz_prob_algo_simple.png" width="1019"></p>
</div>
<div id="creating-jobs" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#creating-jobs" class="anchor"> </a></body></html>Creating jobs</h1>
<p><a href="https://mllg.github.io/batchtools/reference/addExperiments"><code><a href="../reference/addExperiments.html">addExperiments()</a></code></a> is used to parametrize the jobs and thereby define computational jobs. To do so, you have to pass named lists of parameters to <a href="https://mllg.github.io/batchtools/reference/addExperiments"><code><a href="../reference/addExperiments.html">addExperiments()</a></code></a>. The elements of the respective list (one for problems and one for algorithms) must be named after the problem or algorithm they refer to. The data frames contain parameter constellations for the problem or algorithm function where columns must have the same names as the target arguments. When the problem design and the algorithm design are combined in <a href="https://mllg.github.io/batchtools/reference/addExperiments"><code><a href="../reference/addExperiments.html">addExperiments()</a></code></a>, each combination of the parameter sets of the two designs defines a distinct job. How often each of these jobs should be computed can be determined with the argument <code>repls</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># problem design: try two values for the ratio parameter</span>
pdes =<span class="st"> </span><span class="kw">list</span>(<span class="dt">iris =</span> <span class="kw">data.frame</span>(<span class="dt">ratio =</span> <span class="kw">c</span>(<span class="fl">0.67</span>, <span class="fl">0.9</span>)))

<span class="co"># algorithm design: try combinations of kernel and epsilon exhaustively,</span>
<span class="co"># try different number of trees for the forest</span>
ades =<span class="st"> </span><span class="kw">list</span>(
  <span class="dt">svm =</span> <span class="kw">expand.grid</span>(<span class="dt">kernel =</span> <span class="kw">c</span>(<span class="st">"linear"</span>, <span class="st">"polynomial"</span>, <span class="st">"radial"</span>), <span class="dt">epsilon =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="fl">0.1</span>)),
  <span class="dt">forest =</span> <span class="kw">data.frame</span>(<span class="dt">ntree =</span> <span class="kw">c</span>(<span class="dv">100</span>, <span class="dv">500</span>, <span class="dv">1000</span>))
)

<span class="kw"><a href="../reference/addExperiments.html">addExperiments</a></span>(pdes, ades, <span class="dt">repls =</span> <span class="dv">5</span>)</code></pre></div>
<pre><code>## Adding 60 experiments ('iris'[2] x 'svm'[6] x repls[5]) ...</code></pre>
<pre><code>## Adding 30 experiments ('iris'[2] x 'forest'[3] x repls[5]) ...</code></pre>
<p>The jobs are now available in the registry with an individual job ID for each. The function <a href="https://mllg.github.io/batchtools/reference/summarizeExperiments"><code><a href="../reference/summarizeExperiments.html">summarizeExperiments()</a></code></a> returns a table which gives a quick overview over all defined experiments.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/summarizeExperiments.html">summarizeExperiments</a></span>()</code></pre></div>
<pre><code>##    problem algorithm .count
## 1:    iris       svm     60
## 2:    iris    forest     30</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/summarizeExperiments.html">summarizeExperiments</a></span>(<span class="dt">by =</span> <span class="kw">c</span>(<span class="st">"problem"</span>, <span class="st">"algorithm"</span>, <span class="st">"ratio"</span>))</code></pre></div>
<pre><code>##    problem algorithm ratio .count
## 1:    iris       svm  0.67     30
## 2:    iris       svm  0.90     30
## 3:    iris    forest  0.67     15
## 4:    iris    forest  0.90     15</code></pre>
</div>
<div id="before-you-submit" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#before-you-submit" class="anchor"> </a></body></html>Before you submit</h1>
<p>Before submitting all jobs to the batch system, we encourage you to test each algorithm individually. Or sometimes you want to submit only a subset of experiments because the jobs vastly differ in runtime. Another reoccurring task is the collection of results for only a subset of experiments. For all these use cases, <a href="https://mllg.github.io/batchtools/reference/findJobs"><code><a href="../reference/findJobs.html">findExperiments()</a></code></a> can be employed to conveniently select a particular subset of jobs. It returns the IDs of all experiments that match the given criteria. Your selection can depend on substring matches of problem or algorithm IDs using <code>prob.name</code> or <code>algo.name</code>, respectively. You can also pass R expressions, which will be evaluated in your problem parameter setting (<code>prob.pars</code>) or algorithm parameter setting (<code>algo.pars</code>). The expression is then expected to evaluate to a Boolean value. Furthermore, you can restrict the experiments to specific replication numbers.</p>
<p>To illustrate <a href="https://mllg.github.io/batchtools/reference/findJobs"><code><a href="../reference/findJobs.html">findExperiments()</a></code></a>, we will select two experiments, one with a support vector machine and the other with a random forest and the parameter <code>ntree = 1000</code>. The selected experiment IDs are then passed to testJob.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id1 =<span class="st"> </span><span class="kw">head</span>(<span class="kw"><a href="../reference/findJobs.html">findExperiments</a></span>(<span class="dt">algo.name =</span> <span class="st">"svm"</span>), <span class="dv">1</span>)
<span class="kw">print</span>(id1)</code></pre></div>
<pre><code>##    job.id
## 1:      1</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">id2 =<span class="st"> </span><span class="kw">head</span>(<span class="kw"><a href="../reference/findJobs.html">findExperiments</a></span>(<span class="dt">algo.name =</span> <span class="st">"forest"</span>, <span class="dt">algo.pars =</span> (ntree ==<span class="st"> </span><span class="dv">1000</span>)), <span class="dv">1</span>)
<span class="kw">print</span>(id2)</code></pre></div>
<pre><code>##    job.id
## 1:     71</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/testJob.html">testJob</a></span>(<span class="dt">id =</span> id1)</code></pre></div>
<pre><code>## Generating problem instance for problem 'iris' ...
## Applying algorithm 'svm' on problem 'iris' ...</code></pre>
<pre><code>##             pred
##              setosa versicolor virginica
##   setosa         17          0         0
##   versicolor      0         16         2
##   virginica       0          0        15</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/testJob.html">testJob</a></span>(<span class="dt">id =</span> id2)</code></pre></div>
<pre><code>## Generating problem instance for problem 'iris' ...
## Applying algorithm 'forest' on problem 'iris' ...</code></pre>
<pre><code>##             
##              setosa versicolor virginica
##   setosa         17          0         0
##   versicolor      0         16         2
##   virginica       0          0        15</code></pre>
<p>If something goes wrong, <code>batchtools</code> comes with a bunch of useful debugging utilities (see separate vignette on error handling). If everything turns out fine, we can proceed with the calculation.</p>
</div>
<div id="submitting-and-collecting-results" class="section level1">
<h1 class="hasAnchor">
<html><body><a href="#submitting-and-collecting-results" class="anchor"> </a></body></html>Submitting and collecting results</h1>
<p>To submit the jobs, we call <a href="https://mllg.github.io/batchtools/reference/submitJobs"><code><a href="../reference/submitJobs.html">submitJobs()</a></code></a> and wait for all jobs to terminate using <a href="https://mllg.github.io/batchtools/reference/waitForJobs"><code><a href="../reference/waitForJobs.html">waitForJobs()</a></code></a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/submitJobs.html">submitJobs</a></span>()</code></pre></div>
<pre><code>## Ignoring resource 'chunks.as.arrayjobs', not supported by cluster functions 'Multicore'</code></pre>
<pre><code>## Submitting 90 jobs in 90 chunks using cluster functions 'Multicore' ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/waitForJobs.html">waitForJobs</a></span>()</code></pre></div>
<pre><code>## Syncing 88 files ...</code></pre>
<pre><code>## [1] TRUE</code></pre>
<p>After jobs are finished, the results can be collected with <a href="https://mllg.github.io/batchtools/reference/reduceResultsList"><code><a href="../reference/reduceResultsList.html">reduceResultsDataTable()</a></code></a> where we directly extract the mean misclassification error:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">results =<span class="st"> </span><span class="kw"><a href="../reference/reduceResultsList.html">reduceResultsDataTable</a></span>(<span class="dt">fun =</span> function(res) (<span class="kw">list</span>(<span class="dt">mce =</span> (<span class="kw">sum</span>(res) -<span class="st"> </span><span class="kw">sum</span>(<span class="kw">diag</span>(res))) /<span class="st"> </span><span class="kw">sum</span>(res))))
<span class="kw">head</span>(results)</code></pre></div>
<pre><code>##    job.id  mce
## 1:      1 0.04
## 2:      2 0.00
## 3:      3 0.06
## 4:      4 0.04
## 5:      5 0.02
## 6:      6 0.06</code></pre>
<p>Next, we merge the results table with the table of job parameters using one of the <a href="https://mllg.github.io/batchtools/reference/JoinTables">join helpers</a> provided by <code>batchtools</code> (here, we use an inner join):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tab =<span class="st"> </span><span class="kw"><a href="../reference/JoinTables.html">ijoin</a></span>(<span class="kw"><a href="../reference/getJobTable.html">getJobPars</a></span>(), results)
<span class="kw">head</span>(tab)</code></pre></div>
<pre><code>##    job.id problem algorithm ratio     kernel epsilon ntree  mce
## 1:      1    iris       svm  0.67     linear    0.01    NA 0.04
## 2:      2    iris       svm  0.67     linear    0.01    NA 0.00
## 3:      3    iris       svm  0.67     linear    0.01    NA 0.06
## 4:      4    iris       svm  0.67     linear    0.01    NA 0.04
## 5:      5    iris       svm  0.67     linear    0.01    NA 0.02
## 6:      6    iris       svm  0.67 polynomial    0.01    NA 0.06</code></pre>
<p>We now aggregate the results group-wise. You can use <a href="https://cran.r-project.org/package=data.table"><code>data.table</code></a>, <code>base::aggregate()</code>, or the <a href="https://cran.r-project.org/package=dplyr"><code>dplyr</code></a> package for this purpose. Here, we use <a href="https://cran.r-project.org/package=data.table"><code>data.table</code></a> to subset the table to jobs where the ratio is <code>0.67</code> and group by algorithm the algorithm hyperparameters:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">tab[ratio ==<span class="st"> </span><span class="fl">0.67</span>, <span class="kw">list</span>(<span class="dt">mmce =</span> <span class="kw">mean</span>(mce)), by =<span class="st"> </span><span class="kw">c</span>(<span class="st">"algorithm"</span>, <span class="st">"kernel"</span>, <span class="st">"epsilon"</span>, <span class="st">"ntree"</span>)]</code></pre></div>
<pre><code>##    algorithm     kernel epsilon ntree  mmce
## 1:       svm     linear    0.01    NA 0.032
## 2:       svm polynomial    0.01    NA 0.088
## 3:       svm     radial    0.01    NA 0.048
## 4:       svm     linear    0.10    NA 0.032
## 5:       svm polynomial    0.10    NA 0.088
## 6:       svm     radial    0.10    NA 0.048
## 7:    forest         NA      NA   100 0.048
## 8:    forest         NA      NA   500 0.048
## 9:    forest         NA      NA  1000 0.048</code></pre>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#intro">Intro</a></li>
      <li><a href="#problems-and-algorithms">Problems and algorithms</a></li>
      <li><a href="#creating-jobs">Creating jobs</a></li>
      <li><a href="#before-you-submit">Before you submit</a></li>
      <li><a href="#submitting-and-collecting-results">Submitting and collecting results</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michel Lang, Bernd Bischl.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
