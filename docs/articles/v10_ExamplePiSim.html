<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Example 1: Approximation of Pi â€¢ batchtools</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../jquery.sticky-kit.min.js"></script><script src="../pkgdown.js"></script><!-- mathjax --><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-vignette">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">batchtools</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../articles/index.html">Articles</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mllg/batchtools">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9">
    <div class="page-header toc-ignore">
      <h1>Example 1: Approximation of Pi</h1>
            
          </div>

    
    
<div class="contents">
<p>To get a first insight into the usage of <code>batchtools</code>, we start with an exemplary Monte Carlo simulation to approximate <span class="math inline">\(\pi\)</span>. For background information, see <a href="https://en.wikipedia.org/wiki/Monte_Carlo_method">Wikipedia</a>.</p>
<p>First, a so-called registry object has to be created, which defines a directory where all relevant information, files and results of the computational jobs will be stored. There are two different types of registry objects: First, a regular <a href="https://mllg.github.io/batchtools/reference/makeRegistry"><code>Registry</code></a> which we will use in this example. Second, an <a href="https://mllg.github.io/batchtools/reference/makeExperimentRegistry"><code>ExperimentRegistry</code></a> which provides an alternative way to define computational jobs and thereby is tailored for a broad range of large scale computer experiments (see, for example, <a href="ExampleExperiment.html">this vignette</a>). Here, we use a temporary registry which is stored in the temp directory of the system and gets automatically deleted if you close the R session.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(batchtools)
reg =<span class="st"> </span><span class="kw"><a href="../reference/makeRegistry.html">makeRegistry</a></span>(<span class="dt">file.dir =</span> <span class="ot">NA</span>, <span class="dt">seed =</span> <span class="dv">1</span>)</code></pre></div>
<p>For a permanent registry, set the <code>file.dir</code> to a valid path. It can then be reused later, e.g., when you login to the system again, by calling the function <code><a href="../reference/loadRegistry.html">loadRegistry(file.dir)</a></code>.</p>
<p>When a registry object is created or loaded, it is stored for the active R session as the default. Therefore the argument <code>reg</code> will be ignored in functions calls of this example, assuming the correct registry is set as default. To get the current default registry, <a href="https://mllg.github.io/batchtools/reference/makeRegistry"><code>getDefaultRegistry</code></a> can be used. To switch to another registry, use <a href="https://mllg.github.io/batchtools/reference/makeRegistry"><code><a href="../reference/getDefaultRegistry.html">setDefaultRegistry()</a></code></a>.</p>
<p>First, we create a function which samples <span class="math inline">\(n\)</span> points <span class="math inline">\((x_i, y_i)\)</span> whereas <span class="math inline">\(x_i\)</span> and <span class="math inline">\(y_i\)</span> are distributed uniformly, i.e. <span class="math inline">\(x_i, y_i \sim \mathcal{U}(0,1)\)</span>. Next, the distance to the origin <span class="math inline">\((0, 0)\)</span> is calculated and the fraction of points in the unit circle (<span class="math inline">\(d \leq 1\)</span>) is returned.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">piApprox =<span class="st"> </span>function(n) {
  nums =<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">runif</span>(<span class="dv">2</span> *<span class="st"> </span>n), <span class="dt">ncol =</span> <span class="dv">2</span>)
  d =<span class="st"> </span><span class="kw">sqrt</span>(nums[, <span class="dv">1</span>]^<span class="dv">2</span> +<span class="st"> </span>nums[, <span class="dv">2</span>]^<span class="dv">2</span>)
  <span class="dv">4</span> *<span class="st"> </span><span class="kw">mean</span>(d &lt;=<span class="st"> </span><span class="dv">1</span>)
}
<span class="kw">piApprox</span>(<span class="dv">1000</span>)</code></pre></div>
<pre><code>## [1] 3.16</code></pre>
<p>We now parallelize <code>piApprox()</code> with <code>batchtools</code>: We create 10 jobs, each doing a MC simulation with <span class="math inline">\(10^5\)</span> jobs. We use <a href="https://mllg.github.io/batchtools/reference/batchMap"><code><a href="../reference/batchMap.html">batchMap()</a></code></a> to define the jobs (note that this does not yet start the calculation):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/batchMap.html">batchMap</a></span>(<span class="dt">fun =</span> piApprox, <span class="dt">n =</span> <span class="kw">rep</span>(<span class="fl">1e5</span>, <span class="dv">10</span>))</code></pre></div>
<pre><code>## Adding 10 jobs ...</code></pre>
<p>The length of the vector or list defines how many different jobs are created, while the elements itself are used as arguments for the function. The function <code><a href="../reference/batchMap.html">batchMap(fun, ...)</a></code> works analogously to <code>Map(f, ...)</code> of the base package. An overview over the jobs and their IDs can be retrieved with <a href="https://mllg.github.io/batchtools/reference/getJobTable"><code><a href="../reference/getJobTable.html">getJobTable()</a></code></a> which returns a data frame with all relevant information:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">names</span>(<span class="kw"><a href="../reference/getJobTable.html">getJobTable</a></span>())</code></pre></div>
<pre><code>##  [1] "job.id"       "submitted"    "started"      "done"        
##  [5] "error"        "memory"       "batch.id"     "log.file"    
##  [9] "job.hash"     "time.queued"  "time.running" "n"           
## [13] "tags"</code></pre>
<p>Note that a unique job ID is assigned to each job. These IDs can be used to restrict operations to subsets of jobs. To actually start the calculation, call <a href="https://mllg.github.io/batchtools/reference/submitJobs"><code><a href="../reference/submitJobs.html">submitJobs()</a></code></a>. The registry and the selected job IDs can be taken as arguments as well as an arbitrary list of resource requirements, which are to be handled by the cluster back end.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/submitJobs.html">submitJobs</a></span>(<span class="dt">resources =</span> <span class="kw">list</span>(<span class="dt">walltime =</span> <span class="dv">3600</span>, <span class="dt">memory =</span> <span class="dv">1024</span>))</code></pre></div>
<pre><code>## Ignoring resource 'chunks.as.arrayjobs', not supported by cluster functions 'Multicore'</code></pre>
<pre><code>## Submitting 10 jobs in 10 chunks using cluster functions 'Multicore' ...</code></pre>
<p>In this example, a cap for the execution time (so-called walltime) and for the maximum memory requirements are set. The progress of the submitted jobs can be checked with <a href="https://mllg.github.io/batchtools/reference/getStatus"><code><a href="../reference/getStatus.html">getStatus()</a></code></a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/getStatus.html">getStatus</a></span>()</code></pre></div>
<pre><code>## Syncing 9 files ...</code></pre>
<pre><code>## Status for 10 jobs:
##   Submitted : 10 (100.0%)
##   Queued    :  0 (  0.0%)
##   Started   :  9 ( 90.0%)
##   Running   :  1 ( 10.0%)
##   Done      :  9 ( 90.0%)
##   Error     :  0 (  0.0%)
##   Expired   :  0 (  0.0%)</code></pre>
<p>The resulting output includes the number of jobs in the registry, how many have been submitted, have started to execute on the batch system, are currently running, have successfully completed, and have terminated due to an R exception. After jobs have successfully terminated, we can load their results on the master. This can be done in a simple fashion by using either <a href="https://mllg.github.io/batchtools/reference/loadResult"><code><a href="../reference/loadResult.html">loadResult()</a></code></a>, which returns a single result exactly in the form it was calculated during mapping, or by using <a href="https://mllg.github.io/batchtools/reference/reduceResults"><code><a href="../reference/reduceResults.html">reduceResults()</a></code></a>, which is a version of <code>Reduce()</code> from the base package for registry objects.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/waitForJobs.html">waitForJobs</a></span>()</code></pre></div>
<pre><code>## Syncing 1 files ...</code></pre>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">sapply</span>(<span class="dv">1</span>:<span class="dv">10</span>, loadResult))</code></pre></div>
<pre><code>## [1] 3.140652</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/reduceResults.html">reduceResults</a></span>(function(x, y) x +<span class="st"> </span>y) /<span class="st"> </span><span class="dv">10</span></code></pre></div>
<pre><code>## [1] 3.140652</code></pre>
<p>If you are absolutely sure that your function works, you can take a shortcut and use <em>batchtools</em> in an <code>lapply</code> fashion using <a href="https://mllg.github.io/batchtools/reference/btlapply"><code><a href="../reference/btlapply.html">btlapply()</a></code></a>. This function creates a temporary registry (but you may also pass one yourself), calls <a href="https://mllg.github.io/batchtools/reference/reduceResultsList"><code><a href="../reference/batchMap.html">batchMap()</a></code></a>, wait for the jobs to terminate with <a href="https://mllg.github.io/batchtools/reference/waitForJobs"><code><a href="../reference/waitForJobs.html">waitForJobs()</a></code></a> and then uses <a href="https://mllg.github.io/batchtools/reference/reduceResultsList"><code><a href="../reference/reduceResultsList.html">reduceResultsList()</a></code></a> to return the results.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">res =<span class="st"> </span><span class="kw"><a href="../reference/btlapply.html">btlapply</a></span>(<span class="kw">rep</span>(<span class="fl">1e5</span>, <span class="dv">10</span>), piApprox)</code></pre></div>
<pre><code>## Sourcing configuration file '/home/lang/.config/batchtools/config.R' ...</code></pre>
<pre><code>## Adding 10 jobs ...</code></pre>
<pre><code>## Ignoring resource 'chunks.as.arrayjobs', not supported by cluster functions 'Multicore'</code></pre>
<pre><code>## Submitting 10 jobs in 10 chunks using cluster functions 'Multicore' ...</code></pre>
<pre><code>## Syncing 7 files ...</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">mean</span>(<span class="kw">unlist</span>(res))</code></pre></div>
<pre><code>## [1] 3.141884</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Michel Lang, Bernd Bischl.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://hadley.github.io/pkgdown/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  </body>
</html>
