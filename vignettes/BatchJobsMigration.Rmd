---
title: "Migrating from BatchJobs/BatchExperiments"
author: "Michel Lang"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Migrating from BatchJobs/BatchExperiments}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r,include=FALSE}
library(batchtools)
options(batchtools.progress = FALSE)
```

## Notable interface changes

* The packages [BatchJobs](https://github.com/tudo-r/BatchJobs/) and [BatchExperiments](https://github.com/tudo-r/Batchexperiments) have been merged.
* `batchtools` remembers the last created or loaded Registry and makes it the default.
  This way, you do not need to pass the registry around that much.
  If you need to work with multiple registries simultaneously on the other hand, you can still do so by explicitly passing a registry.
* The template file format has changed:
    - The scheduler should directly execute the command `Rscript -e 'batchtools::doJobCollection(<filename>)'`.
      There is no intermediate R source file like in BatchJobs.
    - All information stored in the object `JobDescription` can be access while brewing the template.
      Some variable names have changed and need to be adapted though.
* Most functions now return a [data.table](https://cran.r-project.org/package=data.table) which is keyed with the `job.id`.
  This way, return values can be joined together easily and efficient (see example below).
  Furthermore, you can use these tables to subset ids.
* The function `makeDesign` has been removed.
  Hyperparameters can be defined by just passing a `data.frame` or `data.table` to [addExperiments](https://mllg.github.io/batchtools/addExperiments.html).
  For exhaustive designs, use `expand.grid()` or `data.table::CJ`.

```{r}
library(batchtools)
reg = makeTempRegistry(make.default = TRUE)
batchMap(function(x, y) x + y, x = 1:5, y = 1)
ids = findJobs(x > 3)
print(ids)

# pass ids around ...
getJobPars(ids)
# or subset in a second step
getJobPars()[ids]
```


## Notable internal changes

* `batchtools` does not use a SQL data base anymore.
  Instead all the information is stored directly in the registry using [data.tables](https://cran.r-project.org/package=data.table) acting as an in-memory database.
* Nodes do not have to access the registry. [submitJobs()](https://mllg.github.io/batchtools/submitJobs.html) stores an object of type [JobDescription](https://mllg.github.io/batchtools/JobDescription.html) on the file system.
  This object holds all the information necessary to execute the job or chunk of jobs via [doJobCollection()](https://mllg.github.io/batchtools/doJobCollection.html).
  Each job stores its status updates, log files and results on the file system and [syncRegistry()](https://mllg.github.io/batchtools/syncRegistry.html) can be used on the master to update the registry.
